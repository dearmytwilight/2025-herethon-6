{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ moment.title }}</title>
    <link rel="stylesheet" href="{% static 'css/common/container.css' %}" />
    <link rel="stylesheet" href="{% static 'css/comment_write.css' %}" />
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="back">
                <a href="javascript:history.back()"><img src="{% static 'assets/imges/arrow_back.png' %}" alt="ë’¤ë¡œê°€ê¸°" /></a>
            </div>
            <div class="profile">
                <div class="img">
                    <img src="{{ moment.user.profile_img_url|default:'{% static \'assets/imges/Group 59.png\' %}' }}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" />
                </div>
                <div class="name">
                    <p>{{ moment.user.username }}</p>
                </div>
            </div>
        </div>

        <div class="text">
            <div class="text1">
                <p>{{ moment.title }}</p>
            </div>
            <div class="text2">
                <p>{{ moment.created_date|date:"Y-m-d H:i" }}</p>
            </div>
        </div>

        <div class="input">
            <div class="input2">
                <p>ì‹¤íŒ¨ë‹´</p>
                <textarea id="failure" readonly>{{ moment.content }}</textarea>
            </div>
            <div class="input3">
                <p>ë‚´ê°€ ë§Œì•½ ë‹¤ì‹œ ëŒì•„ê°„ë‹¤ë©´?</p>
                <textarea id="regret" readonly>{% if if_contents %}{{ if_contents.0.if_content }}{% else %}ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.{% endif %}</textarea>
            </div>
        </div>

        <div class="favorite">
            <img src="{% static 'assets/imges/favorite_filled.png' %}" alt="ì¢‹ì•„ìš” ì•„ì´ì½˜" />
        </div>

        <div class="comment_header">
            <div class="chat_icon">
                <img src="{% static 'img/chat_bubble.png' %}" alt="ëŒ“ê¸€ ì•„ì´ì½˜" />
                <span class="comment_count">{{ comment_count }}</span>
            </div>
            <div class="like_icon">
                <img src="{% static 'img/favorite.png' %}" alt="ì¢‹ì•„ìš”" id="likeBtn" data-moment-id="{{ moment.moment_id }}" style="cursor:pointer;" />
                <span id="likeCount">{{ like_count }}</span>
            </div>
        </div>

        <div class="images">
            {% for image in images %}
            <img src="{{ image.image_url }}" alt="{{ image.image_name }}" />
            {% endfor %}
        </div>

        
        <!-- ğŸ’¬ ëŒ“ê¸€ ì‘ì„± í¼ -->
        {% if request.user.is_authenticated %}
        <div id="comment_form" class="comment_write">
        <form method="post" action="/moments/{{ moment.moment_id }}/comments/create/">
            {% csrf_token %}
            <input type="hidden" name="user_id" value="{{ request.user.id }}">
            <textarea name="content" rows="3" placeholder="ëŒ“ê¸€ì„ ì‘ì„±í•˜ì„¸ìš”" required></textarea>
            <button type="submit">ì‘ì„±</button>
            
        </form>
        </div>
        {% endif %}


        <!-- ğŸ’¬ ëŒ“ê¸€ ëª©ë¡ -->
        <div class="comment">
        {% for comment in comments %}
        <div class="comment_item">
            <div class="profile_comment">
            <img src="{{ comment.user.profile_img_url|default:'{% static \'assets/imges/Group 66.png\' %}' }}" alt="ëŒ“ê¸€ í”„ë¡œí•„ ì´ë¯¸ì§€" />
            </div>
            <div class="comment_text">
            <p>{{ comment.content }}</p>

            {% if comment.user_id.id == request.user.id %}
            
            <!-- âœï¸ ëŒ“ê¸€ ìˆ˜ì • form -->
            <form method="post" action="/moments/{{ moment.moment_id }}/comments/{{ comment.comment_id }}/update/">
                {% csrf_token %}
                <input type="hidden" name="user_id" value="{{ request.user.id }}">
                <input type="text" name="content" value="{{ comment.content }}" required>
                <button type="submit">ìˆ˜ì •</button>
            </form>

            <!-- âŒ ëŒ“ê¸€ ì‚­ì œ form -->
            <form method="post" action="/moments/{{ moment.moment_id }}/comments/{{ comment.comment_id }}/delete/" style="margin-top: 5px;">
                {% csrf_token %}
                <input type="hidden" name="user_id" value="{{ request.user.id }}">
                <button type="submit" onclick="return confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
            </form>
            {% endif %}
            </div>
        </div>
        {% empty %}
        <p>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endfor %}
        </div>
    </div>

<script>
    const likeBtn = document.getElementById("likeBtn");
    const likeCount = document.getElementById("likeCount");
    const momentId = likeBtn.dataset.momentId;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    likeBtn.addEventListener("click", () => {
        fetch(`/moments/${momentId}/toggle_like/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie('csrftoken'),
                "Content-Type": "application/json"
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            likeBtn.src = data.liked ? "{% static 'img/favorite_filled.png' %}" : "{% static 'img/favorite.png' %}";
            likeCount.textContent = data.like_count;
        })
        .catch(err => {
            console.error('ì¢‹ì•„ìš” ìš”ì²­ ì‹¤íŒ¨', err);
        });
    });
</script>
</body>
</html>
